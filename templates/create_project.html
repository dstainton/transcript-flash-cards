{% extends "base.html" %}

{% block title %}Create Project{% endblock %}

{% block content %}
<div class="card create-project-card">
    <h1>üéØ Create New Project</h1>
    <p class="page-description">Configure your project and flashcard generation</p>
    
    <div class="document-info">
        <p>üìÑ Processed <strong>{{ document_count }}</strong> document{{ 's' if document_count != 1 else '' }}</p>
    </div>
    
    <form method="POST" class="create-project-form" id="projectForm">
        <!-- Project Name -->
        <div class="form-group">
            <label for="project_name">
                <strong>Project Name</strong>
                <span class="ai-badge">‚ú® AI Suggested</span>
            </label>
            <input type="text" 
                   id="project_name" 
                   name="project_name" 
                   class="form-input" 
                   value="{{ suggested_name }}" 
                   placeholder="Enter project name"
                   required>
            <p class="input-hint">You can modify the AI-generated name or use your own</p>
        </div>
        
        <!-- Topic Strategy Selection -->
        <div class="form-group">
            <label>
                <strong>Topic Organization Strategy</strong>
            </label>
            <div class="strategy-options">
                <div class="strategy-option">
                    <input type="radio" id="strategy-per-file" name="topic_strategy" value="one-per-file" checked>
                    <label for="strategy-per-file" class="strategy-label">
                        <div class="strategy-header">
                            <span class="strategy-icon">üìÑ</span>
                            <strong>One Topic Per File</strong>
                            <span class="recommended-badge">Recommended</span>
                        </div>
                        <p class="strategy-desc">Create one topic for each uploaded document. Best for lesson-based content.</p>
                    </label>
                </div>
                
                <div class="strategy-option">
                    <input type="radio" id="strategy-ai" name="topic_strategy" value="ai-extracted">
                    <label for="strategy-ai" class="strategy-label">
                        <div class="strategy-header">
                            <span class="strategy-icon">ü§ñ</span>
                            <strong>AI-Extracted Topics</strong>
                        </div>
                        <p class="strategy-desc">Let AI analyze all content and intelligently determine optimal topic divisions for learning.</p>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Per-File Configuration (Default) -->
        <div id="perFileConfig" class="form-group config-section">
            <label>
                <strong>Configure Topics & Flashcards</strong>
            </label>
            
            <!-- Flashcard Count Control -->
            <div class="count-control-section">
                <div class="count-control-header">
                    <strong>Flashcard Count Settings</strong>
                </div>
                <div class="count-options">
                    <div class="count-option">
                        <input type="radio" id="use-ai-counts" name="count_mode" value="ai" checked>
                        <label for="use-ai-counts" class="count-option-label">
                            <span class="count-icon">ü§ñ</span>
                            <div class="count-option-text">
                                <strong>Use AI Suggestions</strong>
                                <p>AI analyzes each file and suggests optimal flashcard count</p>
                            </div>
                        </label>
                    </div>
                    <div class="count-option">
                        <input type="radio" id="use-default-count" name="count_mode" value="default">
                        <label for="use-default-count" class="count-option-label">
                            <span class="count-icon">üéØ</span>
                            <div class="count-option-text">
                                <strong>Use My Default</strong>
                                <div class="default-input-group">
                                    <input type="number" 
                                           id="default_count" 
                                           name="default_count" 
                                           class="default-count-input"
                                           value="25"
                                           min="5"
                                           max="50">
                                    <span>cards per topic</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                <p class="count-hint">üí° <strong>Tip:</strong> You can adjust individual topic counts below regardless of which option you choose</p>
            </div>
            
            <p class="section-hint">Customize the topic name and flashcard count for each document</p>
            
            <div class="topics-config">
                {% for doc in documents_data %}
                <div class="topic-config-card">
                    <div class="topic-config-header">
                        <span class="file-icon">üìÑ</span>
                        <div class="file-info-section">
                            <div class="file-name-display">{{ doc.display_filename }}</div>
                            <div class="file-size-display">{{ (doc.text_length / 1024)|round(1) }} KB of text</div>
                        </div>
                    </div>
                    
                    <div class="topic-config-fields">
                        <div class="field-group">
                            <label for="topic_name_{{ loop.index0 }}">Topic Name:</label>
                            <input type="text" 
                                   id="topic_name_{{ loop.index0 }}" 
                                   name="topic_name_{{ loop.index0 }}" 
                                   class="topic-name-input"
                                   value="{{ doc.suggested_topic }}"
                                   required>
                        </div>
                        
                        <div class="field-group">
                            <label for="card_count_{{ loop.index0 }}">
                                Flashcards:
                                <span class="ai-suggestion-badge" title="{{ doc.ai_reasoning }}">
                                    ü§ñ AI: {{ doc.ai_suggested_count }}
                                </span>
                            </label>
                            <input type="number" 
                                   id="card_count_{{ loop.index0 }}" 
                                   name="card_count_{{ loop.index0 }}" 
                                   class="card-count-input"
                                   value="{{ doc.ai_suggested_count }}"
                                   data-ai-count="{{ doc.ai_suggested_count }}"
                                   data-ai-reasoning="{{ doc.ai_reasoning }}"
                                   min="5"
                                   max="50"
                                   required>
                            <div class="ai-reasoning-hint">{{ doc.ai_reasoning }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="config-summary">
                    <strong>Total:</strong> 
                    <span id="perFileTotalTopics">{{ documents_data|length }}</span> topics, 
                    <span id="perFileTotalCards">{{ documents_data|map(attribute='ai_suggested_count')|sum }}</span> flashcards
                </div>
            </div>
        </div>
        
        <!-- AI-Extracted Topics Configuration (Hidden by default) -->
        <div id="aiTopicsConfig" class="form-group config-section" style="display: none;">
            <label>
                <strong>AI-Extracted Topics</strong>
                <span class="ai-badge">‚ú® AI Suggested</span>
            </label>
            <p class="section-hint">Review and customize AI-detected topics and flashcard counts</p>
            
            {% if ai_topics %}
            <input type="hidden" id="numAiTopics" name="num_topics" value="{{ ai_topics|length }}">
            <div class="topics-config">
                {% for topic in ai_topics %}
                <div class="topic-config-card">
                    <div class="topic-config-fields wide">
                        <div class="field-group flex-grow">
                            <label for="ai_topic_name_{{ loop.index0 }}">Topic Name:</label>
                            <input type="text" 
                                   id="ai_topic_name_{{ loop.index0 }}" 
                                   name="ai_topic_name_{{ loop.index0 }}" 
                                   class="ai-topic-name-input"
                                   value="{{ topic.name }}"
                                   required>
                        </div>
                        
                        <div class="field-group">
                            <label for="ai_card_count_{{ loop.index0 }}">Flashcards:</label>
                            <input type="number" 
                                   id="ai_card_count_{{ loop.index0 }}" 
                                   name="ai_card_count_{{ loop.index0 }}" 
                                   class="ai-card-count-input"
                                   value="{{ topic.flashcard_count }}"
                                   min="5"
                                   max="50"
                                   required>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="config-summary">
                    <strong>Total:</strong> 
                    <span id="aiTotalTopics">{{ ai_topics|length }}</span> topics, 
                    <span id="aiTotalCards">{{ ai_topics|sum(attribute='flashcard_count') }}</span> flashcards
                </div>
            </div>
            {% else %}
            <p class="no-topics">AI couldn't extract topics. Please use "One Topic Per File" strategy.</p>
            {% endif %}
        </div>
        
        <!-- Action Buttons -->
        <div class="button-group">
            <button type="submit" class="button button-success">
                üöÄ Create Project & Generate Flashcards
            </button>
            <a href="{{ url_for('upload_documents') }}" class="button button-secondary">
                ‚Üê Back to Upload
            </a>
        </div>
        
        <div class="processing-note">
            <p><strong>‚è±Ô∏è Processing Time:</strong> Generation takes ~30-60 seconds per topic. Please be patient!</p>
        </div>
    </form>
</div>

<style>
.create-project-card {
    max-width: 900px;
    margin: 2rem auto;
}

.page-description {
    text-align: center;
    color: #666;
    margin-bottom: 2rem;
}

.document-info {
    background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 2rem;
    border: 2px solid #4a90e2;
}

.document-info p {
    margin: 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.create-project-form {
    margin-top: 2rem;
}

.form-group {
    margin-bottom: 2rem;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.8rem;
    color: #2c3e50;
    font-size: 1.1rem;
}

.ai-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.recommended-badge {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #d0d0d0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.input-hint, .section-hint {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #666;
}

.section-hint {
    margin-bottom: 1rem;
}

/* Strategy Options */
.strategy-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.strategy-option {
    position: relative;
}

.strategy-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.strategy-label {
    display: block;
    padding: 1.5rem;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.strategy-option input[type="radio"]:checked + .strategy-label {
    border-color: #4a90e2;
    background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
}

.strategy-label:hover {
    border-color: #4a90e2;
}

.strategy-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
}

.strategy-icon {
    font-size: 1.5rem;
}

.strategy-desc {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
    margin-left: 2.3rem;
}

/* Flashcard Count Control Section */
.count-control-section {
    background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
    border: 2px solid #ffd700;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.count-control-header {
    margin-bottom: 1rem;
    color: #2c3e50;
    font-size: 1.05rem;
}

.count-options {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.count-option {
    position: relative;
}

.count-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.count-option-label {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.count-option input[type="radio"]:checked + .count-option-label {
    border-color: #ffd700;
    background: linear-gradient(135deg, #fffdf0 0%, #ffffff 100%);
}

.count-option-label:hover {
    border-color: #ffd700;
}

.count-icon {
    font-size: 1.8rem;
}

.count-option-text {
    flex: 1;
}

.count-option-text strong {
    display: block;
    margin-bottom: 0.3rem;
    color: #2c3e50;
}

.count-option-text p {
    margin: 0;
    font-size: 0.85rem;
    color: #666;
}

.default-input-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.default-count-input {
    width: 80px;
    padding: 6px 10px;
    border: 2px solid #d0d0d0;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
}

.default-count-input:focus {
    outline: none;
    border-color: #4a90e2;
}

.count-hint {
    margin-top: 1rem;
    padding: 0.8rem;
    background: #e3f2fd;
    border-radius: 6px;
    color: #1565c0;
    font-size: 0.9rem;
    border-left: 3px solid #2196f3;
}

/* Topic Configuration Cards */
.config-section {
    border-top: 2px solid #e0e0e0;
    padding-top: 1.5rem;
}

.topics-config {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 12px;
    border: 2px solid #e0e0e0;
}

.topic-config-card {
    background: white;
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 2px solid #e0e0e0;
    transition: all 0.2s ease;
}

.topic-config-card:hover {
    border-color: #4a90e2;
}

.topic-config-card:last-of-type {
    margin-bottom: 0;
}

.topic-config-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.file-icon {
    font-size: 2rem;
}

.file-info-section {
    flex: 1;
}

.file-name-display {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1rem;
}

.file-size-display {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

.topic-config-fields {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1rem;
}

.topic-config-fields.wide {
    grid-template-columns: 3fr 1fr;
}

.field-group {
    display: flex;
    flex-direction: column;
}

.field-group.flex-grow {
    flex: 1;
}

.field-group label {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.4rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-suggestion-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    cursor: help;
}

.topic-name-input, .ai-topic-name-input {
    padding: 10px 14px;
    border: 2px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    width: 100%;
}

.card-count-input, .ai-card-count-input {
    padding: 10px 14px;
    border: 2px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    width: 100%;
}

.topic-name-input:focus, .card-count-input:focus,
.ai-topic-name-input:focus, .ai-card-count-input:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.ai-reasoning-hint {
    font-size: 0.8rem;
    color: #667eea;
    margin-top: 0.3rem;
    font-style: italic;
}

.config-summary {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 2px solid #e0e0e0;
    text-align: center;
    color: #2c3e50;
    font-size: 1.1rem;
}

.no-topics {
    background: #fff3cd;
    padding: 1.5rem;
    border-radius: 8px;
    color: #856404;
    text-align: center;
    border: 2px solid #ffeaa7;
}

.processing-note {
    background: #fff3cd;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-top: 1.5rem;
    border: 1px solid #ffeaa7;
}

.processing-note p {
    margin: 0;
    color: #856404;
    font-size: 0.95rem;
}

.button-success {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
}

.button-success:hover:not(:disabled) {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
}

.button-success:disabled {
    background: #cccccc;
    cursor: not-allowed;
    opacity: 0.6;
}

@media (max-width: 768px) {
    .topic-config-fields {
        grid-template-columns: 1fr;
    }
    
    .topic-config-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .count-options {
        flex-direction: column;
    }
}
</style>

<!-- Add loading overlay for form submission -->
<div id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2>Creating Your Project...</h2>
        <p id="loadingPhase">AI is generating flashcards with explanations. This may take 1-3 minutes.</p>
        <div class="loading-progress-bar">
            <div class="loading-progress-fill" id="progressFill"></div>
        </div>
        <p id="loadingStatus" style="margin-top: 1rem; color: #666; font-size: 0.9rem; line-height: 1.6;">Starting...</p>
    </div>
</div>

<style>
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-content {
    background: white;
    padding: 3rem 2.5rem;
    border-radius: 16px;
    text-align: center;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #e0e0e0;
    border-top: 5px solid #4a90e2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-content h2 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.loading-content p {
    color: #666;
    margin-bottom: 1.5rem;
}

.loading-progress-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}

.loading-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4a90e2 0%, #357abd 100%);
    width: 0%;
    transition: width 0.5s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const perFileConfig = document.getElementById('perFileConfig');
    const aiTopicsConfig = document.getElementById('aiTopicsConfig');
    const strategyPerFile = document.getElementById('strategy-per-file');
    const strategyAi = document.getElementById('strategy-ai');
    const useAiCounts = document.getElementById('use-ai-counts');
    const useDefaultCount = document.getElementById('use-default-count');
    const defaultCountInput = document.getElementById('default_count');
    const cardCountInputs = document.querySelectorAll('.card-count-input');
    
    // Toggle between configurations
    function updateConfigDisplay() {
        if (strategyPerFile.checked) {
            perFileConfig.style.display = 'block';
            aiTopicsConfig.style.display = 'none';
        } else {
            perFileConfig.style.display = 'none';
            aiTopicsConfig.style.display = 'block';
        }
    }
    
    strategyPerFile.addEventListener('change', updateConfigDisplay);
    strategyAi.addEventListener('change', updateConfigDisplay);
    
    // Handle count mode changes
    function updateCardCounts() {
        if (useAiCounts.checked) {
            // Set all cards to AI-suggested values
            cardCountInputs.forEach(input => {
                const aiCount = parseInt(input.dataset.aiCount);
                input.value = aiCount;
            });
        } else {
            // Set all cards to user's default value
            const defaultValue = parseInt(defaultCountInput.value) || 25;
            cardCountInputs.forEach(input => {
                input.value = defaultValue;
            });
        }
        updatePerFileTotal();
    }
    
    useAiCounts.addEventListener('change', updateCardCounts);
    useDefaultCount.addEventListener('change', updateCardCounts);
    
    // Update default count for all topics
    defaultCountInput.addEventListener('change', function() {
        if (useDefaultCount.checked) {
            const defaultValue = parseInt(this.value) || 25;
            cardCountInputs.forEach(input => {
                input.value = defaultValue;
            });
            updatePerFileTotal();
        }
    });
    
    // Update total cards for per-file strategy
    cardCountInputs.forEach(input => {
        input.addEventListener('input', updatePerFileTotal);
    });
    
    function updatePerFileTotal() {
        let total = 0;
        cardCountInputs.forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById('perFileTotalCards').textContent = total;
    }
    
    // Update total cards for AI strategy
    const aiCardCountInputs = document.querySelectorAll('.ai-card-count-input');
    aiCardCountInputs.forEach(input => {
        input.addEventListener('input', updateAiTotal);
    });
    
    function updateAiTotal() {
        let total = 0;
        aiCardCountInputs.forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById('aiTotalCards').textContent = total;
    }
    
    // Form submission with AJAX and real-time progress
    document.getElementById('projectForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        // Show loading overlay
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'flex';
        
        // Get total topics and cards
        let totalTopics, totalCards;
        if (strategyPerFile.checked) {
            totalTopics = parseInt(document.getElementById('perFileTotalTopics').textContent);
            totalCards = parseInt(document.getElementById('perFileTotalCards').textContent);
        } else {
            totalTopics = parseInt(document.getElementById('aiTotalTopics').textContent);
            totalCards = parseInt(document.getElementById('aiTotalCards').textContent);
        }
        
        const progressFill = document.getElementById('progressFill');
        const loadingStatus = document.getElementById('loadingStatus');
        const loadingPhase = document.getElementById('loadingPhase');
        
        // Submit form via AJAX and track real progress
        const formData = new FormData(this);
        let progressId = null;
        let progressCheckInterval = null;
        
        fetch('/create-project-from-documents', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                progressId = data.progress_id;
                
                // Start polling for real progress if we have a progress ID
                if (progressId) {
                    checkProgress(progressId);
                } else {
                    // Fallback: show completion
                    progressFill.style.width = '100%';
                    loadingPhase.textContent = '‚úÖ Project created successfully!';
                    loadingStatus.textContent = `Generated flashcards`;
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500);
                }
            } else {
                // Show error
                overlay.style.display = 'none';
                alert('Error creating project: ' + (data.error || 'Unknown error'));
                window.location.reload();
            }
        })
        .catch(error => {
            overlay.style.display = 'none';
            alert('Failed to create project: ' + error.message);
            window.location.reload();
        });
        
        // Function to check progress from server
        function checkProgress(progId) {
            progressCheckInterval = setInterval(() => {
                fetch(`/creation-progress/${progId}`)
                    .then(response => response.json())
                    .then(progress => {
                        if (progress.status === 'not_found') {
                            clearInterval(progressCheckInterval);
                            return;
                        }
                        
                        const current = progress.current_topic || 0;
                        const total = progress.total_topics || totalTopics;
                        const percentage = total > 0 ? (current / total * 100) : 0;
                        
                        // Update progress bar
                        progressFill.style.width = percentage + '%';
                        
                        // Update status text with real data
                        if (progress.status === 'error') {
                            // Handle error
                            clearInterval(progressCheckInterval);
                            loadingPhase.textContent = '‚ùå Error creating project';
                            loadingStatus.innerHTML = `<span style="color: #e74c3c;">${progress.error || 'An unknown error occurred'}</span>`;
                        } else if (progress.status === 'generating' && progress.current_topic_name) {
                            loadingPhase.textContent = `Generating flashcards with explanations...`;
                            
                            // Build the main status line
                            let statusText = `Topic ${current} of ${total}: "${progress.current_topic_name}"`;
                            statusText += ` (${progress.flashcards_generated || 0} cards so far)`;
                            
                            // Add the detailed current status if available
                            if (progress.current_status) {
                                statusText += `<br><em style="color: #4a90e2;">${progress.current_status}</em>`;
                            }
                            
                            loadingStatus.innerHTML = statusText;
                        } else if (progress.status === 'complete') {
                            progressFill.style.width = '100%';
                            loadingPhase.textContent = '‚úÖ Project created successfully!';
                            loadingStatus.textContent = `Generated ${progress.flashcards_generated} flashcards across ${total} topics`;
                            
                            // Stop polling
                            clearInterval(progressCheckInterval);
                            
                            // Update session with final counts
                            fetch('/update-creation-success', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    project_name: progress.project_name,
                                    flashcard_count: progress.flashcards_generated,
                                    topic_count: progress.topic_count,
                                    progress_id: progressId
                                })
                            }).then(() => {
                                // Redirect after updating session
                                setTimeout(() => {
                                    window.location.href = `/start`;
                                }, 1500);
                            });
                        } else if (progress.status === 'starting') {
                            loadingPhase.textContent = 'Creating Your Project...';
                            loadingStatus.textContent = 'Initializing flashcard generation...';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                    });
            }, 1000); // Poll every 1 second for real updates
        }
    });
});
</script>
{% endblock %}
