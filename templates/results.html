{% extends "base.html" %}

{% block title %}Session Results{% endblock %}

{% block content %}
<div class="card results-card">
    <h1>Session Results</h1>
    
    <div class="results-summary">
        <div class="stat-box">
            <h3>Score</h3>
            <p class="large-text">{{ score }}/{{ total_questions }}</p>
        </div>
        <div class="stat-box">
            <h3>Percentage</h3>
            <p class="large-text">{{ "%.1f"|format(percentage) }}%</p>
        </div>
        {% if mode == 'study' and cards_mastered is defined and cards_mastered > 0 %}
        <div class="stat-box mastery-stat">
            <h3>Cards Mastered</h3>
            <p class="large-text">ğŸ‰ {{ cards_mastered }}</p>
            <p class="mastery-note">Mastered cards won't appear in future sessions</p>
        </div>
        {% endif %}
    </div>

    {% if mode == 'exam' and results %}
    <div class="results-detail">
        <h2>Detailed Results</h2>
        <div class="results-list">
            {% for result in results %}
            <div class="result-item {{ 'correct' if result.is_correct else 'incorrect' }}">
                <div class="result-header">
                    <span class="result-indicator">{{ 'âœ…' if result.is_correct else 'âŒ' }}</span>
                    <p class="question">{{ result.question }}</p>
                </div>
                <div class="result-answers">
                    <p class="answer"><strong>Your answer:</strong> {{ result.user_answer }}</p>
                    <p class="correct-answer"><strong>Correct answer:</strong> {{ result.correct_answer }}</p>
                </div>
                <div class="result-explanation">
                    <p><strong>ğŸ’¡ Explanation:</strong> {{ result.explanation }}</p>
                </div>
                <div class="result-actions">
                    <button class="exclude-btn" onclick="excludeCard(this, '{{ result.question|e }}')" title="Exclude this card from future sessions">
                        ğŸš« Exclude Card
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="button-group">
        <a href="{{ url_for('start') }}" class="button" title="Start a new study or exam session">Start New Session</a>
        <a href="{{ url_for('stats') }}" class="button button-secondary">View Statistics</a>
        <a href="{{ url_for('index') }}" class="button button-tertiary">Home</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function excludeCard(button, question) {
    if (button.disabled) return;
    
    fetch('{{ url_for("exclude_card_route") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'question=' + encodeURIComponent(question)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.textContent = 'âœ“ Excluded';
            button.disabled = true;
            button.classList.add('excluded');
        } else {
            alert('Failed to exclude card: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to exclude card');
    });
}
</script>
{% endblock %}
